# MQTT Commands Reference

Guidelines for controlling valve state and operating mode via MQTT.

---

## üì° MQTT Broker Configuration

| Parameter | Value |
|-----------|-------|
| Host | `26.172.222.181` |
| Port | `1883` |
| Protocol | MQTT v3.1.1 |

---

## üéÆ Mode Commands (Auto/Manual Toggle)

### Switch to Manual Mode

Required before you can control the valve remotely.

**PowerShell:**
```powershell
echo '{"cid":"mode_manual","value":"manual"}' | mosquitto_pub -h 26.172.222.181 -t 'wfms/lab1/cmd/mode' -l
```

**CMD:**
```cmd
mosquitto_pub -h 26.172.222.181 -t "wfms/lab1/cmd/mode" -m "{\"cid\":\"mode_manual\",\"value\":\"manual\"}"
```

**Without `cid` (auto-generated by gateway):**
```powershell
echo '{"value":"manual"}' | mosquitto_pub -h 26.172.222.181 -t 'wfms/lab1/cmd/mode' -l
```

---

### Switch to Auto Mode

In auto mode, the valve is controlled automatically based on flow thresholds.

**PowerShell:**
```powershell
echo '{"cid":"mode_auto","value":"auto"}' | mosquitto_pub -h 26.172.222.181 -t 'wfms/lab1/cmd/mode' -l
```

**CMD:**
```cmd
mosquitto_pub -h 26.172.222.181 -t "wfms/lab1/cmd/mode" -m "{\"cid\":\"mode_auto\",\"value\":\"auto\"}"
```

---

## üîß Valve Commands (ON/OFF Toggle)

### Turn Valve ON

**PowerShell:**
```powershell
echo '{"cid":"valve_on","value":"ON"}' | mosquitto_pub -h 26.172.222.181 -t 'wfms/lab1/cmd/valve' -l
```

**CMD:**
```cmd
mosquitto_pub -h 26.172.222.181 -t "wfms/lab1/cmd/valve" -m "{\"cid\":\"valve_on\",\"value\":\"ON\"}"
```

**Without `cid` (auto-generated by gateway):**
```powershell
echo '{"value":"ON"}' | mosquitto_pub -h 26.172.222.181 -t 'wfms/lab1/cmd/valve' -l
```

---

### Turn Valve OFF

**PowerShell:**
```powershell
echo '{"cid":"valve_off","value":"OFF"}' | mosquitto_pub -h 26.172.222.181 -t 'wfms/lab1/cmd/valve' -l
```

**CMD:**
```cmd
mosquitto_pub -h 26.172.222.181 -t "wfms/lab1/cmd/valve" -m "{\"cid\":\"valve_off\",\"value\":\"OFF\"}"
```

---

## üìä Subscribe to Responses

### Monitor ACK (Acknowledgment)

```powershell
mosquitto_sub -h 26.172.222.181 -t 'wfms/lab1/ack' -v
```

**Expected response:**
```json
wfms/lab1/ack {"cid":"valve_on","ok":true,"reason":"","ts":1736672944}
```

---

### Monitor State (Retained)

```powershell
mosquitto_sub -h 26.172.222.181 -t 'wfms/lab1/state' -v
```

**Expected response:**
```json
wfms/lab1/state {
  "flow": 55,
  "battery": 93,
  "valve": "ON",
  "mode": "manual",
  "valvePath": "binding",
  "valveKnown": true,
  "valveNodeId": "0x1D34",
  "txPending": false,
  "updatedAt": 1736672944
}
```

---

### Monitor All Topics

```powershell
mosquitto_sub -h 26.172.222.181 -t 'wfms/lab1/#' -v
```

---

## üß™ Full Test Sequence

**Terminal 1: Start gateway**
```powershell
cd D:\CODE\Zigbee-Flow-Monitoring-System\wfms
python -m gateway.service
```

**Terminal 2: Monitor responses**
```powershell
mosquitto_sub -h 26.172.222.181 -t 'wfms/lab1/#' -v
```

**Terminal 3: Send commands**
```powershell
# Step 1: Switch to manual mode
echo '{"value":"manual"}' | mosquitto_pub -h 26.172.222.181 -t 'wfms/lab1/cmd/mode' -l

# Wait 1-2 seconds
Start-Sleep -Seconds 2

# Step 2: Turn valve ON
echo '{"value":"ON"}' | mosquitto_pub -h 26.172.222.181 -t 'wfms/lab1/cmd/valve' -l

# Wait 2 seconds
Start-Sleep -Seconds 2

# Step 3: Turn valve OFF
echo '{"value":"OFF"}' | mosquitto_pub -h 26.172.222.181 -t 'wfms/lab1/cmd/valve' -l

# Wait 2 seconds
Start-Sleep -Seconds 2

# Step 4: Switch back to auto mode
echo '{"value":"auto"}' | mosquitto_pub -h 26.172.222.181 -t 'wfms/lab1/cmd/mode' -l
```

---

## üìù Command Payload Format

### Mode Command

| Field | Required | Type | Values | Description |
|-------|----------|------|--------|-------------|
| `cid` | No | string | Any unique ID | Auto-generated if missing |
| `value` | **Yes** | string | `auto`, `manual` | Target mode |
| `by` | No | string | Username | Who sent the command |

**Example:**
```json
{
  "cid": "mode_cmd_123",
  "value": "manual",
  "by": "admin"
}
```

---

### Valve Command

| Field | Required | Type | Values | Description |
|-------|----------|------|--------|-------------|
| `cid` | No | string | Any unique ID | Auto-generated if missing |
| `value` | **Yes** | string | `ON`, `OFF` | Target valve state |
| `by` | No | string | Username | Who sent the command |

**Example:**
```json
{
  "cid": "valve_cmd_456",
  "value": "ON",
  "by": "admin"
}
```

---

## üö® Common Issues

### 1. PowerShell quote escaping error

**Error:**
```
Error: Unknown option 'cid\:\valve_on\,\value\:\ON\}'
```

**Solution:** Use single quotes or `echo` + pipe.
```powershell
# ‚úÖ Correct: single quotes
mosquitto_pub -h 26.172.222.181 -t 'wfms/lab1/cmd/valve' -m '{"value":"ON"}'

# ‚úÖ Correct: echo + pipe
echo '{"value":"ON"}' | mosquitto_pub -h 26.172.222.181 -t 'wfms/lab1/cmd/valve' -l

# ‚ùå Incorrect: double quotes in PowerShell
mosquitto_pub -h 26.172.222.181 -t "wfms/lab1/cmd/valve" -m "{\"value\":\"ON\"}"
```

---

### 2. Valve command rejected (AUTO mode)

**Error ACK:**
```json
{"cid":"valve_123","ok":false,"reason":"rejected: AUTO mode"}
```

**Solution:** Switch to manual mode first.
```powershell
echo '{"value":"manual"}' | mosquitto_pub -h 26.172.222.181 -t 'wfms/lab1/cmd/mode' -l
```

---

### 3. ACK timeout

**Gateway log:**
```
WARNING - ACK timeout for cid=valve_123 after retries
```

**Possible causes:**
- Gateway mode not enabled on the Coordinator: `json {"id":1,"op":"uart_gateway_set","enable":true}`
- COM port is in use by Simplicity Console
- UART cable is not connected

**Solution:**
```bash
# In Simplicity Console, enable gateway mode:
json {"id":1,"op":"uart_gateway_set","enable":true}
```

---

## üîó Related Documentation

- Gateway Service README: ../wfms/README.md
- Project overview & MQTT notes: ../README.md
- Protocol specification: ../wfms/common/proto.py
- Test scripts: ../tests/smoke/

---

## üìû Support

- GitHub Issues: project repository (internal)
- Documentation: D:\CODE\Zigbee-Flow-Monitoring-System\docs\
- Logs: gateway logs at D:\CODE\Zigbee-Flow-Monitoring-System\wfms\gateway.log

---

Last updated: January 12, 2026
